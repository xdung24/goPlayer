name: Build Release

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux-x64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'

      - name: Install audio dependencies
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev

      - name: Build
        run: GOOS=linux GOARCH=amd64 CGO_ENABLED=1 go build -o goplayer-linux-x64
        shell: bash

      - name: Upload binary
        uses: softprops/action-gh-release@v1
        with:
          files: goplayer-linux-x64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  build-linux-x86:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'

      - name: Install 32-bit audio dependencies
        run: sudo dpkg --add-architecture i386 && sudo apt-get update && sudo apt-get install -y gcc-multilib libc6-dev-i386 libasound2-dev:i386

      - name: Build
        run: PKG_CONFIG_PATH=/usr/lib/i386-linux-gnu/pkgconfig GOOS=linux GOARCH=386 CGO_ENABLED=1 go build -o goplayer-linux-x86
        shell: bash

      - name: Upload binary
        uses: softprops/action-gh-release@v1
        with:
          files: goplayer-linux-x86
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker buildx build --platform linux/arm64 -f Dockerfile.arm64 -t goplayer-builder:arm64 .
        shell: bash

      - name: Build with Docker
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            goplayer-builder:arm64 \
            sh -c "CGO_ENABLED=1 GOOS=linux GOARCH=arm64 go build -ldflags='-extldflags=-static' -buildvcs=false -o goplayer-linux-arm64"
        shell: bash

      - name: Upload binary
        uses: softprops/action-gh-release@v1
        with:
          files: goplayer-linux-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux-armv7:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker buildx build --platform linux/arm/v7 -f Dockerfile.armv7 -t goplayer-builder:armv7 .
        shell: bash

      - name: Build with Docker
        run: |
          docker run --rm --platform linux/arm/v7 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            goplayer-builder:armv7 \
            sh -c "CGO_ENABLED=1 GOOS=linux GOARCH=arm GOARM=7 go build -ldflags='-extldflags=-static' -buildvcs=false -o goplayer-linux-armv7"
        shell: bash

      - name: Upload binary
        uses: softprops/action-gh-release@v1
        with:
          files: goplayer-linux-armv7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows-x64:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'

      - name: Build
        run: CGO_ENABLED=1 go build -o goplayer-windows-x64.exe
        shell: bash

      - name: Upload binary
        uses: softprops/action-gh-release@v1
        with:
          files: goplayer-windows-x64.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}